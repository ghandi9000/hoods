---
title: "Neighborhood Exploratory Graphics"
date: "Generated: `r Sys.Date()`"
runtime: shiny
output:
    html_document:
        toc: true
        toc_depth: 3
        theme: spacelab
        highlight: zenburn
        number_sections: false
---

```{r global_opts, include=FALSE}
knitr::opts_chunk$set(fig.path='./Figs', echo=FALSE, warning=FALSE, message=FALSE,
                    dev='svg')
```
-------------------

# Info
* [code](https://github.com/ghandi9000/hoods)
* Basic neighbor relationship to target: BA / Distance, negative exponential decrease?
* Ways to __quantify__ a neighborhood (possibly relative to target size where applicable):
    + Sum total neighbor values (ie. BA/Distance)
    + Max neighbor value
    + Mean/median neighbor value
    + Number of neighbors
    + Avg. distance
    + Avg. weighted distance (same as mean neighbor value maybe)
    + Species proportions
* Ways to __assess__ effects of neighborhood value on target:
    + [DBH, Height, BV, BA] Growth
    + Ratios [Height/BA, ...]
    + Species
    + Decline index

---------------------

# Setup 
* Neighbor radii:
    + `1` is just the quadrat containing target
    + `2` is 3x3 (2 quadrats in all directions from target, including target's quadrat)
    + `3` is 5x5

```{r setup}

require(xtable)

source("setup.R")
source("hood_functions.R")

## Total target sample size
nbrs <- pp %>% group_by(YEAR, PPLOT) %>%
  filter(STAT == "ALIVE",
         !is.na(BQUDX), BQUDX > 0, BQUDX < 11,
         !is.na(BQUDY), BQUDY > 0, BQUDY < 11,
         !is.na(DBH))
# 
# sampleSize <- nbrs %>%
#   summarise(Total = n())

renderText({ "Total Sample Sizes by Plot/Year:"})
renderTable({
  sampleTable <- table(nbrs$YEAR, nbrs$PPLOT)
  addmargins(sampleTable) #, caption = "Total sample sizes")
})
```

```{r shiny_vars, cache=FALSE}
require(magrittr)
require(dplyr)
require(ggplot2)

selectInput("nRad", "Choose Neighbor Radius:",
            choices=c(1, 2, 3))
nRad <- reactive(as.numeric(input$nRad))  # get neighbor radius from input
nMat <- reactive({
    rad <- nRad()
    if (file.exists(paste0("temp/nm", rad, ".rds"))) readRDS(paste0("temp/nm", rad, ".rds"))
    else {
        nLst <- mnm(tPars = tPars, nPars = nPars, dPars = dPars, nCols = nCols,
                    nRad = rad, dat = matDat, parallel=F)
        nmat <- mnm_to_matrix(nLst)
        saveRDS(paste0("temp/nm", rad, ".rds"))
        nmat
    }
})

renderText({
    paste("Target sample sizes with neighbor radius:", nRad())
})

renderTable({
    nmat <- nMat()  # make neighbor matrices  
    targetTable <- table(nmat$targets$time, nmat$targets$pplot)
    addmargins(targetTable) #, caption = "Target sample sizes")
})

## Neighbor counts
selectInput("splitBy", "Split counts by:",
            choices=c("Don't split", "Aspect", "Elevation", "Plot"))
splitBy <- reactive({
  if (input$splitBy == "Aspect") "aspcl"
  else if (input$splitBy == "Elevation") "elevcl"
  else if (input$splitBy == "Plot") "pplot"
  else FALSE
})

nCounts <- reactive({ nm <- nMat(); rowSums(!is.na(nm$ba) )})
renderPlot({
  sp <- splitBy()
  r <- nRad()
  nm <- nMat()
  counts <- nCounts()
  if (sp != FALSE)
    ggplot(cbind(counts=counts, nm$targets), aes(counts)) +
    geom_histogram() + 
    facet_wrap(as.formula(paste("~", sp))) +
    ggtitle(paste0("Histograms of Neighbor Counts(radius=", r, ")"))
  else
    hist(counts, main=paste0("Histogram of Neighbor Counts (radius=", r, ")"))
})

# renderPlot({
#     nmat <- nMat()
#     ggplot(nmat$targets, aes(ba)) + geom_histogram()
# })

```

# Plot-Level Distributions
Look more closely at specific plots and the distributions of targets/neighbors.
```{r plot_distributions, cache=FALSE}

sidebarLayout(
  
  sidebarPanel(
    helpText("Choose individual plot for closer inspection."),
    selectInput("plot", "Choose Plot:", choices=unique(pp$PPLOT)),
    br(),
    selectInput("type", "Plot Type:", choices=c("Histogram", "Position", "Density", "Scatter")),
    conditionalPanel(
      condition = "input.type == 'Scatter'",
      selectInput("yVar", "Y", choices=c("HT", "HTOBS", "DBH", "BV", "BA")),
      selectInput("xVar", "X", choices=c("DBH", "BV", "BA", "HT", "HTOBS")),
      checkboxInput("smoother", "Add smoothed spline"),
      conditionalPanel(
        condition = "input.smoother == true",
        selectInput("smoothMethod", "Method",
              list("loess", "lm", "glm", "gam", "rlm"))
        )
      ),
    conditionalPanel(
      condition = "input.type == 'Position'",
      checkboxInput("colorTargets", "Color Targets")
      ),
    checkboxInput("chooseSpec", "Choose Species"),
    conditionalPanel(
      condition = "input.chooseSpec == true",
      checkboxGroupInput("spec", "Species:", choices=c(levels(pp$SPEC)), selected=c("ABBA"))
      ),
    br(),
    checkboxInput("targets", "Just Targets")
    ),
      
  mainPanel(  
    renderPlot({
      plot <- as.numeric(input$plot)
      r <- nRad()
      nm <- nMat()
      species <- levels(pp$SPEC)
      if (input$chooseSpec)
        species <- input$spec
      nmInds <- nm$targets$pplot == plot & nm$targets$spec %in% species
      ppInds <- pp$PPLOT == plot & pp$STAT == "ALIVE" & pp$SPEC %in% species
      if (input$targets) 
        ppInds <- ppInds & pp$id %in% nm$targets[nmInds, "id"]
      
      if (input$type == "Histogram") {
        counts <- rowSums(!is.na(nm$ba[nmInds,]))
        p1 <- ggplot(cbind(counts=counts, nm$targets[nmInds,]), aes(counts)) +
          geom_histogram() + facet_wrap(~time) +
          ggtitle(paste0("Histograms of Neighbor Counts(radius=", r, "), Plot=", plot))
        print(p1)
      }
      else if (input$type == "Density") {
        specs <- pp[ppInds,] %>% group_by(SPEC, YEAR) %>% filter(n() > 2)
        ggplot(specs, aes(BQUDX, BQUDY, size=BA, color=SPEC)) + 
          geom_density2d() + facet_wrap(~YEAR) +
          ggtitle("Species Densities (removed species with counts <= 2)")
      }
      else if (input$type == "Position") {
        p1 <- ggplot(pp[ppInds,], aes(BQUDX, BQUDY, size=BA, color=SPEC)) + geom_point(alpha=0.5) +
          facet_wrap(~YEAR) + xlim(0.8, 10.2) + ylim(0.8, 10.2) + geom_hline(yintercept=c(1, 10)) +
          geom_vline(xintercept=c(1, 10))
        if (input$colorTargets) {
          inds <- pp$PPLOT == plot & pp$STAT == "ALIVE" & pp$id %in% nm$targets[nmInds, "id"]
          p1 <- p1 + geom_point(data=pp[inds,], aes(BQUDX, BQUDY), color="red")
          }
        print(p1)
      }
      else if (input$type == "Scatter") {
        p1 <- ggplot(pp[ppInds,], aes_string(input$xVar, input$yVar, color="YEAR")) + 
          geom_point(alpha=0.5) +
          ggtitle(paste(input$yVar,"vs", input$xVar, "Plot=", plot))
        if (input$smoother)
          p1 <- p1 + geom_smooth(fill=NA, method=input$smoothMethod)
        print(p1)
        }
      })
    
    )
)

```


---------------------

# Neighborhoods and Growth
Examine various ways of estimating neighborhood values and look, visually, at the effect on growth.

```{r hoods_growth, cache=FALSE}

sidebarLayout(
  
  sidebarPanel(
    helpText("Choose individual plot for closer inspection."),
    selectInput("plot2", "Choose Plot:", choices=unique(pp$PPLOT)),
    br()
    ),
  
  mainPanel(
    renderPlot({
      plot <- as.numeric(input$plot2)
      ggplot(pp[pp$PPLOT == plot,], aes(DBH, HT, color=YEAR)) + geom_point(alpha=0.5)
      })
    )
  )


```


---------------------

# Permanent Plots

---------------------

# Transect Plots
